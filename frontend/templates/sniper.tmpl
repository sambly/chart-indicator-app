<link rel="stylesheet" href="{{ .EntryCSS }}">

<div class="container mt-2">
    <div class="mb-2">
        <a href="/" class="btn btn-primary btn-sm">На главную</a>
    </div>

    <div class="card mb-2">
        <div class="card-header py-1">
            <h5 class="card-title mb-0">Индикатор SniperTrend</h5>
        </div>
        <div class="card-body p-2 d-flex flex-column">
            <!-- Основные формы в row -->
            <div class="row g-1 mb-2"> <!-- Убрал align-items-end -->
                <!-- Форма 1: Основные параметры -->
                <div class="col-md-6 d-flex flex-column">
                    <form method="GET" action="/sniper" id="mainForm" class="border rounded p-1 flex-grow-1" style="height: 250px; overflow-y: auto;">
                        <h6 class="mb-1">Основные параметры</h6>
                        <input type="hidden" name="form_type" value="update">
                        
                        <div class="mb-1">
                            <label for="symbol" class="form-label small mb-0">Тикер:</label>
                            <input type="text" class="form-control form-control-sm" id="symbol" name="symbol" value="{{ or .FormValues.symbol "BTC-USD" }}">
                        </div>
                        
                        <div class="mb-1">
                            <label for="start_date" class="form-label small mb-0">Начальная дата:</label>
                            <input type="date" class="form-control form-control-sm" id="start_date" name="start_date" value="{{ or .FormValues.start_date "2025-01-01" }}">
                        </div>
                        
                        <div class="mb-1">
                            <label for="end_date" class="form-label small mb-0">Конечная дата:</label>
                            <input type="date" class="form-control form-control-sm" id="end_date" name="end_date" value="{{ or .FormValues.end_date "2025-07-30" }}">
                        </div>
                        
                        <div class="mb-1">
                            <label for="interval" class="form-label small mb-0">Интервал:</label>
                            <select class="form-select form-select-sm" id="interval" name="interval">
                                <option value="60" {{ if eq (or .FormValues.interval "3600") "60" }}selected{{ end }}>1 минута</option>
                                <option value="300" {{ if eq (or .FormValues.interval "3600") "300" }}selected{{ end }}>5 минут</option>
                                <option value="900" {{ if eq (or .FormValues.interval "3600") "900" }}selected{{ end }}>15 минут</option>
                                <option value="3600" {{ if eq (or .FormValues.interval "3600") "3600" }}selected{{ end }}>1 час</option>
                                <option value="d" {{ if eq (or .FormValues.interval "3600") "d" }}selected{{ end }}>День</option>
                            </select>
                        </div>
                    </form>
                    <button type="submit" form="mainForm" class="btn btn-primary btn-sm w-100 mt-1">Обновить</button>
                </div>

                <div class="col-md-6 d-flex flex-column">
                    <form method="GET" action="/sniper" id="configForm" class="border rounded p-1 flex-grow-1" style="height: 250px; overflow-y: auto;">
                        <h6 class="mb-1">Настройки индикатора</h6>
                        <input type="hidden" name="form_type" value="config">
                        <div id="configFields" style="max-height: 220px; overflow-y: auto;">
                        </div>
                    </form>
                    <button type="submit" form="configForm" class="btn btn-primary btn-sm w-100 mt-1">Применить</button>
                </div>
            </div>

            <!-- Форма оптимизации под row -->
            <div class="mb-2">
                <form method="GET" action="/sniper" id="optimizeForm" class="border rounded p-2">
                    <div class="d-flex gap-2">
                        <button type="submit" name="form_type" value="optimize" class="btn btn-warning btn-sm">
                            Оптимизировать параметры
                        </button>
                        <button type="submit" name="form_type" value="save" class="btn btn-primary btn-sm">
                            Сохранить настройки
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- График -->
            <div id="chart" class="flex-grow-1" style="min-height: 400px; width: 100%;"></div>
        </div>
    </div>
</div>

<script type="module">
    import {{ .EntryJS }};

    const sniperConfig = {{ .Config }};
    const chartData = {{ .ChartData }};
    const signalBuyPoints = {{ .SignalBuyPoints }};
    const signalSellPoints = {{ .SignalSellPoints }};

    const config = JSON.parse(sniperConfig);
    
    // Генерация полей формы
    function generateConfigFields() {
        const container = document.getElementById('configFields');
        if (!container) return;
        
        for (const [key, value] of Object.entries(config)) {
            const div = document.createElement('div');
            div.className = 'mb-1';
            div.innerHTML = `
                <label class="form-label small mb-0">${key}:</label>
                <input type="number" class="form-control form-control-sm" name="${key}" value="${value}" step="0.01">
            `;
            container.appendChild(div);
        }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        generateConfigFields();
        
        if (window.buildSniper && chartData) {
            buildSniper(chartData, signalBuyPoints, signalSellPoints, sniperConfig);
        }
    });
</script>